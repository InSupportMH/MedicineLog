const list = document.getElementById('medicineList');
const btnAdd = document.getElementById('btnAddMedicine');
const btnClear = document.getElementById('btnClear');

// Open camera/photo picker when button is pressed
list.addEventListener('click', function (e) {
    const btn = e.target.closest('.photo-btn');
    if (!btn) return;

    const item = btn.closest('.medicine-item');
    const fileInput = item?.querySelector('.medicine-photo-input');
    fileInput?.click();
});

// When a photo is selected, show preview inside the button
list.addEventListener('change', function (e) {
    const fileInput = e.target.closest('.medicine-photo-input');
    if (!fileInput) return;

    const item = fileInput.closest('.medicine-item');
    const btn = item?.querySelector('.photo-btn');
    const img = item?.querySelector('.photo-thumb');

    const file = fileInput.files && fileInput.files[0];
    if (!file || !img || !btn) return;

    // Create a local preview URL
    const url = URL.createObjectURL(file);

    // Clean up previous preview URL if any
    if (img.dataset.url) URL.revokeObjectURL(img.dataset.url);

    img.dataset.url = url;
    img.src = url;

    img.classList.remove('d-none');
    btn.classList.add('has-photo');
});
// Cache one "prototype" row generated by Razor (includes all data-val attributes)
const prototype = list.querySelector('.medicine-item')?.cloneNode(true);

function normalizeItem(item, index, clearValues) {
    item.dataset.index = index;

    // Update "Läkemedel X"
    const nameLabel = item.querySelector('.medicine-label');
    if (nameLabel) nameLabel.textContent = `Läkemedel ${index + 1}`;

    // Update indexes in all MVC/unobtrusive validation attributes
    item.querySelectorAll('[name]').forEach(el => {
        el.name = el.name.replace(/Medicines\[\d+\]/g, `Medicines[${index}]`);
    });

    item.querySelectorAll('[id]').forEach(el => {
        el.id = el.id.replace(/Medicines_\d+__/g, `Medicines_${index}__`);
    });

    item.querySelectorAll('label[for]').forEach(el => {
        const f = el.getAttribute('for');
        if (f) el.setAttribute('for', f.replace(/Medicines_\d+__/g, `Medicines_${index}__`));
    });

    item.querySelectorAll('[data-valmsg-for]').forEach(el => {
        const v = el.getAttribute('data-valmsg-for');
        if (v) el.setAttribute('data-valmsg-for', v.replace(/Medicines\[\d+\]/g, `Medicines[${index}]`));
    });

    if (clearValues) {
        item.querySelectorAll('input').forEach(inp => {
            if (inp.type != 'number') {
                inp.value = '';
            }
            else {
                inp.value = '1';
            }
            inp.classList.remove('is-valid', 'is-invalid', 'input-validation-error');
        });

        item.querySelectorAll('span[data-valmsg-for]').forEach(span => {
            span.textContent = '';
            span.classList.remove('field-validation-error');
            span.classList.add('field-validation-valid');
        });

        // Clear photo preview
        const img = item.querySelector('.photo-thumb');
        const btn = item.querySelector('.photo-btn');
        if (img) {
            if (img.dataset.url) URL.revokeObjectURL(img.dataset.url);
            delete img.dataset.url;
            img.src = '';
            img.classList.add('d-none');
        }
        btn?.classList.remove('has-photo');
    }

    const removeBtn = item.querySelector('.btnRemoveMedicine');
    if (removeBtn) {
        removeBtn.classList.toggle('d-none', index === 0);
    }
}

function renumberAll() {
    Array.from(list.querySelectorAll('.medicine-item'))
        .forEach((item, idx) => normalizeItem(item, idx, false));
}

function addMedicineRow() {
    console.log("addMedicineRow");
    const index = list.querySelectorAll('.medicine-item').length;

    const base = prototype ?? list.querySelector('.medicine-item')?.cloneNode(true);
    if (!base) return;

    const item = base.cloneNode(true);
    normalizeItem(item, index, true);

    list.appendChild(item);

}

// Add
btnAdd?.addEventListener('click', addMedicineRow);

// Remove (event delegation)
list.addEventListener('click', function (e) {
    const btn = e.target.closest('.btnRemoveMedicine');
    if (!btn) return;

    const item = btn.closest('.medicine-item');
    if (!item) return;

    item.remove();

    // Keep at least 1 row
    if (list.querySelectorAll('.medicine-item').length === 0) {
        addMedicineRow();
    } else {
        renumberAll();
        //reparseValidation();
    }
});

export function clearForm() {
    const form = document.getElementById('regForm');
    form?.reset();

    list.querySelectorAll('.medicine-item').forEach(x => x.remove());
    addMedicineRow();

    // Clear validation messages + styles
    form?.querySelectorAll('.field-validation-error, .text-danger')
        .forEach(el => el.textContent = '');

    form?.querySelectorAll('.input-validation-error, .is-invalid, .is-valid')
        .forEach(el => el.classList.remove('input-validation-error', 'is-invalid', 'is-valid'));

    //reparseValidation();
}

// Clear button
btnClear?.addEventListener('click', function () {
    clearForm();
});